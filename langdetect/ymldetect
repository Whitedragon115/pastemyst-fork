version: "3.8"
services:
  db:
    image: mongo:4.4.1
    volumes:
      - mongo_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    restart: unless-stopped
    networks:
      - pastemyst-network

  app:
    pull_policy: build
    build:
      context: ./
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - db
    links:
      - db:db.docker.local
    ports:
      - 8007:80
    volumes:
      - .:/app
    environment:
      # Add environment variables for better logging
      - DEBIAN_FRONTEND=noninteractive
    networks:
      - pastemyst-network    # Resource limits to prevent TensorFlow from consuming too much memory
    mem_limit: 4g
    memswap_limit: 4g
    # Health check for guesslang-autodetect
    healthcheck:
      test: ["CMD", "guesslang-autodetect", "--version", "||", "echo", "def test(): pass", ">", "/tmp/health.py", "&&", "guesslang-autodetect", "/tmp/health.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  mongo_data:
    driver: local

networks:
  pastemyst-network:
    driver: bridge
  
